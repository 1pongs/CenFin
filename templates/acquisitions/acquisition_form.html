{% extends "base.html" %}
{% load crispy_forms_tags %}
{% block title %}{% if object %}Edit{% else %}New{% endif %} Acquisition Â· CENFIN{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
{% endblock %}

{% block content %}
<div id="form-container" class="container py-4">
  <a href="#" onclick="history.back();return false;" class="btn btn-outline-secondary btn-sm d-inline-flex align-items-center gap-1 mb-3">
  <i class="bi bi-arrow-left"></i> Back
</a>
  <div class="row justify-content-center">
    <div class="col-lg-8 col-xl-6">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-3 d-flex justify-content-between">
          <h2 class="fs-4 mb-0">{% if object %}Edit{% else %}Add{% endif %} Acquisition</h2>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-success btn-sm" id="quick-account-btn">+ Account</button>
            <button type="button" class="btn btn-success btn-sm" id="quick-entity-btn">+ Entity</button>
            <button type="button" class="btn btn-success btn-sm" id="quick-category-btn">+ Category</button>
          </div>
        </div>
          <div class="card-body">
            {% if object and object.sell_tx %}
              <div class="alert alert-warning">
                This acquisition has already been sold. You cannot edit the acquisition record directly.
                To modify the sale details, please edit the related transactions: the profit transaction and the capital return transfer.
              </div>
              <div class="mb-3">
                <a href="{% url 'transactions:transaction_update' object.sell_tx.pk %}" class="btn btn-primary btn-sm">Edit Profit Transaction</a>
                <a href="{% url 'transactions:transaction_list' %}?q={{ object.name|urlencode }}" class="btn btn-secondary btn-sm">Find Capital Return Transaction</a>
              </div>
              <div class="d-flex justify-content-end mt-3">
                <a href="{% url 'acquisitions:acquisition-list' %}" class="btn btn-outline-secondary">Back to list</a>
              </div>
            {% else %}
              <form method="post" novalidate>
                {% csrf_token %}
                {% crispy form %}
              </form>
              {% if object %}
              <div class="d-flex justify-content-end mt-3">
                <a href="{% url 'acquisitions:acquisition-delete' object.pk %}" class="btn btn-danger">Delete</a>
              </div>
              {% endif %}
            {% endif %}
          </div>
      </div>
    </div>
  </div>
</div>

{% include "includes/balance_summary.html" %}

<!-- ===================== QUICK ADD MODALS ===================== -->
<div class="modal fade" id="modal-account" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">New Account</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="quick-account-form">
          {% csrf_token %}
          {{ quick_account_form|crispy }}
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary" form="quick-account-form">Save</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modal-entity" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">New Entity</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="quick-entity-form">
          {% csrf_token %}
          {{ quick_entity_form|crispy }}
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary" form="quick-entity-form">Save</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modal-category" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">New Category</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="quick-category-form">
          {% csrf_token %}
          <div class="mb-3">
            <label for="quick-category-name" class="form-label">Name</label>
            <input id="quick-category-name" name="name" class="form-control" required />
          </div>
          <div class="mb-3">
            <label for="quick-category-transaction-type" class="form-label">Transaction type</label>
            <select id="quick-category-transaction-type" name="transaction_type" class="form-select"></select>
          </div>
          <div class="mb-3">
            <label for="quick-category-entity" class="form-label">Entity</label>
            <select id="quick-category-entity" name="entity" class="form-select"></select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary" form="quick-category-form">Save</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  const accModal = new bootstrap.Modal(document.getElementById('modal-account'));
  const entModal = new bootstrap.Modal(document.getElementById('modal-entity'));
  const catModal = new bootstrap.Modal(document.getElementById('modal-category'));

  function addOptionPreserve(select, value, label) {
    if (!select) return;
    const prev = select.value ?? '';
    const valStr = String(value);
    let opt = Array.from(select.options).find(o => o.value === valStr);
    if (opt) {
      opt.text = label;
    } else {
      opt = new Option(label, valStr, false, false);
      select.add(opt);
    }
    select.value = prev;
    select.dispatchEvent(new Event('change', { bubbles: true }));
  }

  function addOptionToSelects(ids, value, label) {
    ids.forEach(id => {
      const sel = document.getElementById(id);
      if (!sel) return;
      addOptionPreserve(sel, value, label);
    });
  }

  document.getElementById('quick-account-btn').addEventListener('click', () => accModal.show());
  document.getElementById('quick-entity-btn').addEventListener('click', () => entModal.show());
  const quickCatBtn = document.getElementById('quick-category-btn');
  if (quickCatBtn) quickCatBtn.addEventListener('click', () => {
    const modalTx = document.getElementById('quick-category-transaction-type');
    const modalEnt = document.getElementById('quick-category-entity');
    if (modalTx && modalTx.options.length === 0) {
      ['buy acquisition', 'sell acquisition', 'income', 'expense', 'transfer'].forEach(val => {
        const label = val.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        modalTx.add(new Option(label, val));
      });
      try { modalTx.value = 'buy acquisition'; } catch (err) {}
    }
    const entSel = document.getElementById('id_entity_source') || document.getElementById('id_entity_destination');
    if (modalEnt && entSel && modalEnt.options.length <= 1) {
      Array.from(entSel.options).forEach(o => { if (o.value !== '') modalEnt.add(new Option(o.text, o.value)); });
    }
    try {
      if (modalEnt && entSel) modalEnt.value = entSel.value || '';
    } catch (err) {}
    catModal.show();
  });

  document.getElementById('quick-account-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const resp = await fetch('/api/create/account/', {
      method: 'POST',
      body: new FormData(e.target)
    });
    if (resp.ok) {
      const data = await resp.json();
      addOptionToSelects(['id_account_source','id_account_destination'], data.id, data.name);
      accModal.hide();
      e.target.reset();
    }
  });

  document.getElementById('quick-entity-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const resp = await fetch('/api/create/entity/', {
      method: 'POST',
      body: new FormData(e.target)
    });
    if (resp.ok) {
      const data = await resp.json();
      addOptionToSelects(['id_entity_source','id_entity_destination'], data.id, data.name);
      entModal.hide();
      e.target.reset();
    }
  });

  document.getElementById('quick-category-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const resp = await fetch('/transactions/tags/', {
      method: 'POST',
      body: new FormData(e.target)
    });
    if (resp.ok) {
      const data = await resp.json();
      const sel = document.getElementById('id_category');
      addOptionPreserve(sel, data.id, data.name);
      catModal.hide();
      e.target.reset();
    } else {
      const text = await resp.text();
      alert('Could not create category: ' + text);
    }
  });

  const accountCurrencies = JSON.parse('{{ account_currency_map|escapejs }}');
  const accSrc = document.getElementById('id_account_source');
  const accDest = document.getElementById('id_account_destination');
  const entSrc = document.getElementById('id_entity_source');
  const entDest = document.getElementById('id_entity_destination');
  const catInput = document.getElementById('id_category');
  const amountLabel = document.querySelector('label[for="id_amount"]');

  function acctCurrency(select){
    if(!select) return '';
    return accountCurrencies[select.value] || '';
  }

  function updateAmountLabel(){
    if(!amountLabel) return;
    const cur = acctCurrency(accSrc);
    amountLabel.textContent = cur ? `Amount (${cur})` : 'Amount';
  }

  if(accSrc) accSrc.addEventListener('change', updateAmountLabel);
  document.addEventListener('DOMContentLoaded', updateAmountLabel);

  // Require entity/account before enabling Category (amount stays editable)
  function prereqsReady(){
    const selects = [accSrc, accDest, entSrc, entDest];
    for (const sel of selects){
      if (!sel) continue;
      if (sel.disabled) continue;
      if (!sel.value) return false;
    }
    return true;
  }
  function updatePrereqState(){
    if (catInput) catInput.disabled = !prereqsReady();
  }
  [accSrc, accDest, entSrc, entDest].forEach(el => el && el.addEventListener('change', updatePrereqState));
  document.addEventListener('DOMContentLoaded', updatePrereqState);
</script>
<script>
  // Ensure required-field stars are consistent for acquisition form fields
  (function ensureAcqRequiredStars(){
    const ids = ['id_entity_source','id_entity_destination','id_account_source','id_account_destination','id_amount','id_category','id_name','id_date'];
    function cleanAndAdd(lbl){
      if (!lbl) return;
      // remove stray literal '*' text nodes and existing small star nodes
      Array.from(lbl.childNodes).forEach(n => {
        if (n.nodeType === 3 && n.textContent && n.textContent.trim() === '*') n.remove();
        if (n.nodeType === 1 && n.classList && n.classList.contains('req-star')) n.remove();
      });
      // append a single red star
      const star = document.createElement('span');
      star.className = 'req-star';
      star.textContent = '*';
      star.style.color = '#dc3545';
      star.style.fontWeight = '600';
      star.style.marginLeft = '0.25rem';
      lbl.appendChild(star);
    }

    function run(root=document){
      ids.forEach(id => {
        try{
          const lbl = root.querySelector(`label[for="${id}"]`) || (root.getElementById && root.getElementById(id) && root.getElementById(id).closest('label'));
          if (lbl) cleanAndAdd(lbl);
        } catch(e) {}
      });
    }

    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', () => run()); else run();

    const mo = new MutationObserver(muts => { muts.forEach(m => { m.addedNodes && Array.from(m.addedNodes).forEach(n => { if (n.nodeType === 1) run(n); }); }); });
    mo.observe(document.body, { childList: true, subtree: true });
  })();
</script>
{% endblock %}
