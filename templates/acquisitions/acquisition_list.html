{% extends "base.html" %}
{% load humanize dict_extras acquisition_tags %}
{% block title %}Acquisitions Â· CENFIN{% endblock %}

{% block content %}
<h1 class="mb-4">Acquisitions</h1>
<div class="d-flex flex-wrap align-items-center gap-2 mb-3">
  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAcqModal">
    <i class="bi bi-plus-lg me-1"></i>Add Acquisition
  </button>
  <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#addInsModal">
    Subscribe Insurance Policy
  </button>
  <form id="filter-form" method="get" class="ms-auto d-flex gap-2">
    <select name="category" class="form-select" style="max-width: 12rem;">
      <option value="">All Categories</option>
      {% for value,label in form.category.field.choices %}
      <option value="{{ value }}" {% if value == current_category %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
    <input type="month" name="month" class="form-control" value="{{ current_month }}">
  </form>
</div>

<!-- Entity selection modal -->
<div class="modal fade" id="addAcqModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="get" action="{% url 'acquisitions:acquisition-create' %}">
        <div class="modal-header">
          <h5 class="modal-title">Select Entity</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <select name="entity" class="form-select" required>
            {% for ent in entities %}
              <option value="{{ ent.pk }}">{{ ent.entity_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Continue</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Insurance entity selection modal -->
<div class="modal fade" id="addInsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="get" action="{% url 'acquisitions:acquisition-create' %}">
        <input type="hidden" name="category" value="insurance">
        <div class="modal-header">
          <h5 class="modal-title">Select Entity</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <select name="entity" class="form-select" required>
            {% for ent in entities %}
              <option value="{{ ent.pk }}">{{ ent.entity_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Continue</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% if urgent_qs %}
<h4 class="text-danger mb-3"><i class="bi bi-exclamation-triangle-fill me-1"></i>Coming up for sale</h4>
<div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xxl-4 g-3 mb-4">
  {% for acq in urgent_qs %}
    {% render_acquisition_card acq urgent=True %}
  {% endfor %}
</div>
{% endif %}

<div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xxl-4 g-3">
  {% for acq in acquisitions %}
    {% render_acquisition_card acq %}
  {% empty %}
    <p class="text-center">No acquisitions.</p>
  {% endfor %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('filter-form');
  if(form){
    form.querySelectorAll('select,input').forEach(el => {
      el.addEventListener('change', () => form.submit());
    });
  }
});
</script>
{% endblock %}