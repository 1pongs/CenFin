{% extends "base.html" %}
{% load humanize crispy_forms_tags static acquisition_tags currency_tags %}

{% block extra_css %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="{% static 'css/accounts.css' %}">
{% endblock %}

{% block content %}
{% url 'entities:list' as back_url %}
{% include "includes/back_button.html" with url=back_url %}
  <div class="d-flex justify-content-between align-items-center mt-3">
    <div class="d-flex align-items-center gap-2">
      <h2 class="mb-0">{{ entity.entity_name }}</h2>
      {% if not entity.is_account_entity and not entity.is_system_default %}
      <a href="{% url 'entities:edit' entity.pk %}?next={{ request.path }}" class="edit-entity-link small" title="Edit">Edit</a>
      {% endif %}
    </div>
    <div>
    <a href="{% url 'transactions:category_manager' %}?entity={{ entity.pk }}" class="btn btn-outline-primary btn-sm me-2">
      <i class="bi bi-tags me-1"></i>Categories
    </a>
    <a href="{% url 'accounts:create' %}" class="btn btn-success btn-sm me-2">
      <i class="bi bi-plus-lg me-1"></i>Add Account
    </a>
  </div>
</div>

<ul class="nav nav-tabs my-3">
  <li class="nav-item">
    <a class="nav-link{% if not current_category %} active{% endif %}" href="{% url 'entities:accounts' entity.pk %}{% if nav_qs %}?{{ nav_qs }}{% endif %}">Accounts</a>
  </li>
  <li class="nav-item">
    <a class="nav-link{% if current_category == 'product' %} active{% endif %}" href="{% url 'entities:accounts' entity.pk %}?category=product{% if nav_qs %}&{{ nav_qs }}{% endif %}">Products</a>
  </li>
  <li class="nav-item">
    <a class="nav-link{% if current_category == 'stock_bond' %} active{% endif %}" href="{% url 'entities:accounts' entity.pk %}?category=stock_bond{% if nav_qs %}&{{ nav_qs }}{% endif %}">Stock &amp; Bond</a>
  </li>
  <li class="nav-item">
    <a class="nav-link{% if current_category == 'property' %} active{% endif %}" href="{% url 'entities:accounts' entity.pk %}?category=property{% if nav_qs %}&{{ nav_qs }}{% endif %}">Property</a>
  </li>
  <li class="nav-item">
    <a class="nav-link{% if current_category == 'vehicle' %} active{% endif %}" href="{% url 'entities:accounts' entity.pk %}?category=vehicle{% if nav_qs %}&{{ nav_qs }}{% endif %}">Vehicle</a>
  </li>
  <li class="nav-item">
    <a class="nav-link{% if current_category == 'equipment' %} active{% endif %}" href="{% url 'entities:accounts' entity.pk %}?category=equipment{% if nav_qs %}&{{ nav_qs }}{% endif %}">Equipment</a>
  </li>
</ul>

<div class="row">
  <div class="col-lg-8 mb-4">
    {% if not current_category %}
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="text-muted small">Balances for this entity only</div>
        <div class="fw-bold text-end">
        {% display total_balance base_currency.code as disp_total %}
        Total Balance:
        <span class="amount-display" data-prefix="{{ active_currency_symbol }}" data-decimals="2">{{ disp_total|floatformat:2|intcomma }}</span>
        </div>
      </div>
      {% for a in accounts %}
        <div class="card shadow-sm rounded-lg mb-3 p-3">
          <div class="d-flex align-items-center">
            <div class="me-3 icon-box flex-shrink-0">
              <i class="bi bi-wallet2 fs-3 text-primary"></i>
            </div>
            <div class="flex-grow-1">
              <div class="fw-semibold">
                <a href="{% url 'transactions:transaction_list' %}?account={{ a.id }}&entity={{ entity.pk }}" class="text-decoration-none">{{ a.name }}</a>
              </div>
              <small class="text-muted">{{ a.type }}</small>
              <div class="small text-muted">Transactions: {{ a.tx_count }}</div>
            </div>
            <div class="ms-auto fw-bold">
              {% display a.balance a.currency.code as disp_bal %}
              <span class="amount-display" data-prefix="{{ active_currency_symbol }}" data-decimals="2">{{ disp_bal|floatformat:2|intcomma }}</span>
            </div>
          </div>
        </div>
      {% empty %}
        {% include 'includes/no_accounts.html' %}
      {% endfor %}
    {% else %}
      <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-2 row-cols-xxl-3 g-3">
        {% for acq in acquisitions %}
          {% render_acquisition_card acq %}
        {% empty %}
          <p class="text-center">No acquisitions.</p>
        {% endfor %}
      </div>
    {% endif %}
  </div>
  <aside class="col-lg-4">
    <div class="p-3 sidebar rounded mb-3">
    {% if not current_category %}
        {% include 'entities/_toolbar_accounts.html' %}
      {% elif current_category == 'product' %}
        {% include 'entities/_toolbar_products.html' %}
      {% elif current_category == 'stock_bond' %}
        {% include 'entities/_toolbar_stock_bond.html' %}
      {% elif current_category == 'property' %}
        {% include 'entities/_toolbar_property.html' %}
      {% elif current_category == 'vehicle' %}
        {% include 'entities/_toolbar_vehicle.html' %}
      {% elif current_category == 'equipment' %}
        {% include 'entities/_toolbar_equipment.html' %}
      {% endif %}
    </div>
  </aside>
</div>

{# Insert analytics below account/acquisition list so it appears after the tabs #}
{% include 'entities/_analytics_fragment.html' %}

{% endblock %}

{% block extra_js %}{% endblock %}
