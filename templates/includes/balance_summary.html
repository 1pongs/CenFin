<div id="account-balance-wrapper" class="mb-3 d-flex align-items-center d-none">
  <label class="form-label me-2 mb-0">Balance:</label>
  <span id="account-balance-field" style="display:inline-block"></span>
  <div id="account-balance-spinner" class="spinner-border spinner-border-sm text-secondary ms-2 d-none" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>
<div id="entity-balance-wrapper" class="mb-3 d-flex align-items-center d-none">
  <label class="form-label me-2 mb-0">Balance:</label>
  <span id="entity-balance-field" style="display:inline-block"></span>
  <div id="entity-balance-spinner" class="spinner-border spinner-border-sm text-secondary ms-2 d-none" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const accField = document.getElementById('id_account_source');
    const entField = document.getElementById('id_entity_source');
    const accWrapper = document.getElementById('account-balance-wrapper');
    const entWrapper = document.getElementById('entity-balance-wrapper');
    const accBalanceField = document.getElementById('account-balance-field');
    const entBalanceField = document.getElementById('entity-balance-field');
    const accSpinner = document.getElementById('account-balance-spinner');
    const entSpinner = document.getElementById('entity-balance-spinner');

     function insertFields() {
      if (accField) accField.insertAdjacentElement('afterend', accWrapper);
      if (entField) entField.insertAdjacentElement('afterend', entWrapper);
    }
    async function fetchBalance(acc, ent) {
      accSpinner.classList.remove('d-none');
      entSpinner.classList.remove('d-none');
      try {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 5000);
        const resp = await fetch(`{% url 'transactions:pair_balance' %}?account=${acc}&entity=${ent}`, { signal: controller.signal });
        clearTimeout(timeout);
        if (resp.ok) {
          const data = await resp.json();
          const amt = parseFloat(data.balance);
          if (!isNaN(amt)) {
            const text = `â‚± ${amt.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            accBalanceField.textContent = text;
            entBalanceField.textContent = text;
            accWrapper.classList.remove('d-none');
            entWrapper.classList.remove('d-none');
          } else {
            accWrapper.classList.add('d-none');
            entWrapper.classList.add('d-none');
          }
        } else {
          accWrapper.classList.add('d-none');
          entWrapper.classList.add('d-none');
          console.error('Balance fetch failed', resp.status);
        }
      } catch (err) {
        accWrapper.classList.add('d-none');
        entWrapper.classList.add('d-none');
        console.error(err);
      } finally {
        accSpinner.classList.add('d-none');
        entSpinner.classList.add('d-none');
      }
    }

    function update() {
      const acc = accField && accField.value;
      const ent = entField && entField.value;
      if (acc && ent) {
        accWrapper.classList.remove('d-none');
        entWrapper.classList.remove('d-none');
        accBalanceField.textContent = '';
        entBalanceField.textContent = '';
        fetchBalance(acc, ent);
      } else {
        accWrapper.classList.add('d-none');
        entWrapper.classList.add('d-none');
        accBalanceField.textContent = '';
        entBalanceField.textContent = '';
      }
    }

    insertFields();
    update();
    
    if (accField) accField.addEventListener('change', update);
    if (entField) entField.addEventListener('change', update);
  });
  </script>