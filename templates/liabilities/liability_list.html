{% extends 'liabilities/base.html' %}
{% load humanize static currency_tags %}

{% block extra_css %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
{% endblock %}

{% block liabilities_content %}
<div class="row">
  <div class="col-lg-8 mb-4">
    {% if undo_restore_url %}
      <div class="alert alert-success d-flex justify-content-between align-items-center" role="alert">
        <div>
          {% if undo_liability_kind == 'loan' %}
            {% if undo_liability_name %}Loan "{{ undo_liability_name }}"{% else %}Loan{% endif %} deleted.
          {% else %}
            {% if undo_liability_name %}Credit card "{{ undo_liability_name }}"{% else %}Credit card{% endif %} deleted.
          {% endif %}
        </div>
        <div>
          <a href="{{ undo_restore_url }}" class="btn btn-sm btn-success">Undo</a>
        </div>
      </div>
    {% endif %}
    {% if tab == 'loans' %}
      <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-2 row-cols-xxl-3 g-3 mb-4">
        {% for loan in loans %}
          <div class="col">
          {% url 'liabilities:loan-edit' loan.pk as edit_url %}
          {% display loan.principal_amount loan.currency as disp_principal %}
          {% with loan_amt=disp_principal|floatformat:2|intcomma %}
          {% with '<span class="amount-display" data-prefix="'|add:active_currency_symbol|add:'" data-decimals="2">'|add:loan_amt|add:'</span>' as loan_amt_html %}
          {% url 'transactions:transaction_create' as tx_create %}
          {% with loan_pk=loan.pk|stringformat:"s" %}
          {% with '<a href="'|add:edit_url|add:'" class="btn btn-sm btn-secondary">View</a> <a href="'|add:tx_create|add:'?transaction_type=loan_repayment&loan='|add:loan_pk|add:'" class="btn btn-sm btn-primary">Pay</a>' as buttons %}
          {% include 'components/card.html' with title=loan.lender.name subtitle=loan_amt_html|safe rows=loan.field_tags buttons=buttons|safe modifier='card-loan' %}
          {% endwith %}
          {% endwith %}
          {% endwith %}
          {% endwith %}
          </div>
        {% empty %}
          <div class="card text-center p-5">
            <i class="bi bi-wallet2 fs-1 mb-3 text-muted"></i>
            <p class="mb-0">No loans.</p>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-2 row-cols-xxl-3 g-3 mb-4">
        {% for card in credit_cards %}
          <div class="col">
          {% url 'liabilities:credit-edit' card.pk as edit_url %}
          {% url 'transactions:transaction_create' as tx_create %}
          {% with acc_pk=card.account.pk|stringformat:"s" %}
          {% with '<a href="'|add:edit_url|add:'" class="btn btn-sm btn-secondary">View</a> <a href="'|add:tx_create|add:'?transaction_type=cc_payment&account_destination='|add:acc_pk|add:'" class="btn btn-sm btn-primary">Pay</a>' as buttons %}
          {% include 'components/card.html' with title=card.card_name subtitle=card.issuer.name rows=card.field_tags buttons=buttons|safe modifier='card-credit' %}
          {% endwith %}
          {% endwith %}
          </div>
        {% empty %}
        <div class="card text-center p-5">
            <i class="bi bi-credit-card fs-1 mb-3 text-muted"></i>
            <p class="mb-0">No credit cards.</p>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>
  <aside class="col-lg-4">
    <div class="p-3 sidebar rounded">
      {% if tab == 'loans' %}
        <a href="{% url 'liabilities:loan-create' %}" class="btn btn-success w-100 mb-3">
          <i class="bi bi-plus-lg me-1"></i>Add
        </a>
        <a href="{% url 'liabilities:loan-archived' %}" class="btn btn-outline-secondary w-100 mb-3">
          <i class="bi bi-archive me-1"></i>View Archived
        </a>
      {% else %}
        <a href="{% url 'liabilities:credit-create' %}" class="btn btn-success w-100 mb-3">
          <i class="bi bi-plus-lg me-1"></i>Add
        </a>
        <a href="{% url 'liabilities:credit-archived' %}" class="btn btn-outline-secondary w-100 mb-3">
          <i class="bi bi-archive me-1"></i>View Archived
        </a>
      {% endif %}
      {% include 'liabilities/_toolbar.html' %}
    </div>
  </aside>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('filter-form');
    if(form){
      form.querySelectorAll('select,input').forEach(el => {
        el.addEventListener('change', () => form.submit());
      });
    }
  });
</script>
{% endblock %}
