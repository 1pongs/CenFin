{# transactions/template_form.html #}
{% extends "base.html" %}
{% load crispy_forms_tags %}

{# ───────────────────────── page title ───────────────────────── #}
{% block title %}
  {% if form.instance.pk %}Edit{% else %}New{% endif %} Template · CENFIN
{% endblock %}

{# ───────────────────────── content ─────────────────────────── #}
{% block content %}
  <div class="container-md" style="max-width: 920px;">
    <h1 class="mb-4 fw-semibold">
      {% if form.instance.pk %}Edit{% else %}New{% endif %} Template
    </h1>

    {# top toolbar ----------------------------------------------------- #}
    <div class="d-flex flex-wrap align-items-center gap-2 mb-4">
      <a href="{% url 'transactions:template_create' %}" class="btn btn-primary fw-semibold">
        <i class="bi bi-plus-lg me-1"></i>New Template
      </a>

      <select id="template-select"
              class="form-select flex-grow-1"
              style="min-width: 260px;"
              aria-label="Select template">
        <option value="">Please select template form</option>
        {% for tpl in templates %}
          <option value="{{ tpl.pk }}" {% if form.instance.pk == tpl.pk %}selected{% endif %}>
            {{ tpl.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    {# card wrapper ---------------------------------------------------- #}
    <div class="card shadow-sm border-0">
      <div class="card-body p-4">
        <form method="post" novalidate>
          {% csrf_token %}

          {# 2-column responsive grid via Bootstrap -------------------- #}
          <div class="row g-3">
            <div class="col-md-6">{{ form.name|as_crispy_field }}</div>
            <div class="col-md-6">{{ form.description|as_crispy_field }}</div>

            <div class="col-md-6">{{ form.date|as_crispy_field }}</div>
            <div class="col-md-6">{{ form.transaction_type|as_crispy_field }}</div>

            <div class="col-md-6">{{ form.amount|as_crispy_field }}</div>

            <div class="col-md-6">{{ form.account_source|as_crispy_field }}</div>
            <div class="col-md-6">{{ form.account_destination|as_crispy_field }}</div>

            <div class="col-md-6">{{ form.entity_source|as_crispy_field }}</div>
            <div class="col-md-6">{{ form.entity_destination|as_crispy_field }}</div>

            <div class="col-12">{{ form.remarks|as_crispy_field }}</div>
            {{ form.autopop_map }}
          </div>

          {# buttons --------------------------------------------------- #}
          <div class="d-flex justify-content-end gap-2 mt-4">
            <button type="submit" class="btn btn-primary px-4">Save</button>
            <a href="{% url 'transactions:template_list' %}" class="btn btn-outline-secondary">Cancel</a>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
<script>
  /* keep current value so we can revert if user cancels navigation */
  const sel  = document.getElementById('template-select');
  const form = document.querySelector('form');          // ← grab the form
  sel.dataset.current = sel.value;

  /* track unsaved changes */
  let isDirty = false;
  document.querySelectorAll('form input, form textarea, form select')
    .forEach(el => el.addEventListener('input', () => isDirty = true));

  /* ❶ clear the flag exactly when the user hits Save  */
  form.addEventListener('submit', () => {
      isDirty = false;                // no longer “dirty”
      window.removeEventListener('beforeunload', handleBeforeUnload);
  });

  /* … show warning only if isDirty is still true … */
  function handleBeforeUnload(e) {
      if (isDirty) {
          e.preventDefault();
          e.returnValue = '';
      }
  }
  window.addEventListener('beforeunload', handleBeforeUnload);

  /* dropdown navigation with confirmation */
  sel.addEventListener('change', function () {
      if (!this.value) return;
      if (isDirty && !confirm('You have unsaved changes. Discard them?')) {
          this.value = this.dataset.current;
          return;
      }
      window.location.href = `/transactions/templates/${this.value}/edit/`;
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const toastElList = document.querySelectorAll('.toast');
    toastElList.forEach(toastEl => {
      const t = bootstrap.Toast.getOrCreateInstance(toastEl, {
        delay: 4000,        // 4 seconds; palitan kung gusto
        autohide: true
      });
      t.show();
    });
  });
</script>
{% endblock %}
