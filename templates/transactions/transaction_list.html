{% extends "base.html" %}
{% load humanize %}
{% block title %}Transactions Â· CENFIN{% endblock %}
{% block content %}
<div class="container mx-auto px-4">
  <div class="flex flex-wrap items-center justify-between py-6">
    <div class="flex items-center gap-2">
      <a href="{% url 'transactions:transaction_create' %}" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded">New Transaction</a>
      <a href="{% url 'transactions:template_list' %}" class="bg-yellow-400 hover:bg-yellow-500 text-black px-3 py-2 rounded">Template</a>
    </div>
    <div class="flex items-center gap-2">
      <button type="button" class="border px-2 py-1 rounded">&lt;</button>
      <select class="border rounded px-2 py-1">
        <option>Last 7 days</option>
        <option>Last 30 days</option>
        <option>Last 90 days</option>  
      </select>
       <button type="button" class="border px-2 py-1 rounded">&gt;</button>
    </div>
    <div class="flex items-center gap-2">
      <select id="bulk-action" name="bulk-action" class="form-select" form="bulk-form">
        <option value="">-- Action --</option>
        <option value="delete">Delete selected</option>
      </select>
      <button type="submit" form="bulk-form" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded">Apply</button>
    </div>
  </div>

  <form method="get" class="flex flex-wrap gap-4 my-4">
    <select name="transaction_type" class="border rounded px-2 py-1">
      {% for val, label in txn_type_choices %}
      <option value="{{ val }}" {% if request.GET.transaction_type == val %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
    <select name="account_source" class="border rounded px-2 py-1">
      <option value="">---------</option>
      {% for a in accounts %}
      <option value="{{ a.id }}" {% if request.GET.account_source == a.id|stringformat:'s' %}selected{% endif %}>{{ a.account_name }}</option>
      {% endfor %}
    </select>
    <select name="account_destination" class="border rounded px-2 py-1">
      <option value="">---------</option>
      {% for a in accounts %}
      <option value="{{ a.id }}" {% if request.GET.account_destination == a.id|stringformat:'s' %}selected{% endif %}>{{ a.account_name }}</option>
      {% endfor %}
    </select>
    <select name="entity_source" class="border rounded px-2 py-1">
      <option value="">---------</option>
      {% for e in entities %}
      <option value="{{ e.id }}" {% if request.GET.entity_source == e.id|stringformat:'s' %}selected{% endif %}>{{ e.entity_name }}</option>
      {% endfor %}
    </select>
    <select name="entity_destination" class="border rounded px-2 py-1">
      <option value="">---------</option>
      {% for e in entities %}
      <option value="{{ e.id }}" {% if request.GET.entity_destination == e.id|stringformat:'s' %}selected{% endif %}>{{ e.entity_name }}</option>
      {% endfor %}
    </select>
    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded">Apply Filters</button>
  </form>  

  <form method="post" id="bulk-form">
    {% csrf_token %}
    <div class="overflow-x-auto">
      <table class="w-full text-sm border">
        <thead class="bg-gray-800 text-white font-bold">
          <tr>
            <th class="p-2 text-center">
              <input type="checkbox" id="select-all" class="form-check-input">
            </th>
            <th class="p-2 text-left">Date</th>
          <th class="p-2 text-left">Description</th>
          <th class="p-2 text-left">Transaction</th>
          <th class="p-2 text-left">From</th>
          <th class="p-2 text-left">To</th>
          <th class="p-2 text-right">Amount</th>
        </tr>
      </thead>
        <tbody class="bg-white">
          {% for txn in transactions %}
          <tr class="hover:bg-gray-50">
            <td class="p-2 text-center">
              <input type="checkbox" name="selected_ids" value="{{ txn.id }}" class="row-checkbox form-check-input">
          </td>
          <td class="p-2">{{ txn.date|date:"M d, Y" }}</td>
          <td class="p-2">{{ txn.description }}</td>
          <td class="p-2">{{ txn.get_transaction_type_display }}</td>
          <td class="p-2">{{ txn.account_source.account_name }}</td>
          <td class="p-2">{{ txn.account_destination.account_name }}</td>
          <td class="p-2 text-right">{{ txn.amount|floatformat:2 }}</td>
        </tr>
        {% empty %}
          <tr>
          <td colspan="7" class="p-2 text-center">No transactions yet.</td>
        </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>

document.addEventListener('DOMContentLoaded', () => {
  const selectAll = document.getElementById('select-all');
  const rowCbs = document.querySelectorAll('.row-checkbox');

  if (selectAll) {
    selectAll.addEventListener('change', () => {
      rowCbs.forEach(cb => cb.checked = selectAll.checked);
    });
  }
  const bulkSelect = document.getElementById('bulk-action');
  const applyBtn = document.getElementById('apply-bulk');
  if (bulkSelect && applyBtn) {
    const toggleBtn = () => {
      const enabled = bulkSelect.value !== '';
      applyBtn.disabled = !enabled;
      applyBtn.classList.toggle('opacity-50', !enabled);
      applyBtn.classList.toggle('cursor-not-allowed', !enabled);
    };
    bulkSelect.addEventListener('change', toggleBtn);
    toggleBtn();
    }
});
</script>
{% endblock %}
