{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load crispy_forms_tags humanize %}

{% block title %}
  Transactions Â· CENFIN
{% endblock %}

{% block extra_css %}
  <style>
    /* Hide checkbox column by default */
    .select-checkbox {
      display: none;
    }
  </style>
{% endblock %}

{% block content %}
  <h1 class="mb-4">Transactions</h1>
  <div class="flex gap-6">
    <aside class="w-64 lg:w-72 bg-white shadow-sm p-4 shrink-0">
      <h2 class="font-bold mb-4">Filters</h2>
      <form method="get" id="filter-form" class="space-y-3">
        <div>
          <label class="block text-sm font-medium mb-1">Transaction type</label>
          <select name="transaction_type" class="w-full form-select form-select-sm">
            {% for val,label in txn_type_choices %}
              <option value="{{ val }}" {% if request.GET.transaction_type == val %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">From account</label>
          <select name="account_source" class="w-full form-select form-select-sm">
            <option value="">---------</option>
            {% for a in accounts %}
              <option value="{{ a.id }}" {% if request.GET.account_source == a.id|stringformat:'s' %}selected{% endif %}>{{ a.account_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">To account</label>
          <select name="account_destination" class="w-full form-select form-select-sm">
            <option value="">---------</option>
            {% for a in accounts %}
              <option value="{{ a.id }}" {% if request.GET.account_destination == a.id|stringformat:'s' %}selected{% endif %}>{{ a.account_name }}</option>
            {% endfor %}
          </select>
        </div>
         <div>
          <label class="block text-sm font-medium mb-1">From entity</label>
          <select name="entity_source" class="w-full form-select form-select-sm">
            <option value="">---------</option>
            {% for e in entities %}
              <option value="{{ e.id }}" {% if request.GET.entity_source == e.id|stringformat:'s' %}selected{% endif %}>{{ e.entity_name }}</option>
            {% endfor %}
          </select>
        </div>
         <div>
          <label class="block text-sm font-medium mb-1">To entity</label>
          <select name="entity_destination" class="w-full form-select form-select-sm">
            <option value="">---------</option>
            {% for e in entities %}
              <option value="{{ e.id }}" {% if request.GET.entity_destination == e.id|stringformat:'s' %}selected{% endif %}>{{ e.entity_name }}</option>
            {% endfor %}
          </select>
        </div>
        <button type="submit" class="btn btn-success w-full">Apply filters</button>
      </form>
    </aside>

    <div class="flex-1">
      <div class="flex items-center justify-between gap-4 py-4 border-b">
        <div class="flex gap-2">
          <a href="{% url 'transactions:transaction_create' %}" class="btn btn-primary">New Transaction</a>
          <a href="{% url 'transactions:template_list' %}" class="btn btn-warning">Template</a>
        </div>
        <div class="flex items-center gap-1">
          <button>&lt;</button>
          <select class="form-select form-select-sm"></select>
          <button>&gt;</button>
        </div>
        <div class="flex items-center gap-2">
          <select id="action-select" name="action" class="form-select form-select-sm w-44">
            <option value="">--Bulk action--</option>
            <option value="delete_multiple">Delete Multiple</option>
          </select>
          <button id="apply-button" type="submit" form="bulk-action-form" class="btn btn-primary disabled:opacity-50 disabled:cursor-not-allowed">Apply</button>
        </div>
      </div>


      {# ==== bulk delete ==== #}
  <div class="overflow-x-auto mt-6">
    <div class="mb-2">
      <label class="inline-flex items-center select-checkbox">
        <input type="checkbox" id="select-all" class="form-check-input d-none">
        <span class="ml-2">Select all</span>
      </label>
    </div>
    <form
      method="post"
      id="bulk-action-form"
      action="{% url 'transactions:bulk_action' %}"
    >
      {% csrf_token %}
      <table class="w-full text-sm">
        <thead class="bg-gray-800 text-white font-semibold">
          <tr>
            <th class="select-checkbox w-10"></th>
          <th>Date</th>
          <th>Description</th>
          <th>Transaction</th>
          <th>From</th>
          <th>To</th>
          <th class="text-end">Amount</th>
        </tr>
      </thead>
      <tbody>
        {% for txn in object_list %}
          <tr class="clickable-row hover:bg-gray-50" data-href="{% url 'transactions:transaction_update' txn.pk %}">
            <td class="select-checkbox">
              <input type="checkbox" name="selected_ids" value="{{ txn.id }}" class="form-check-input row-checkbox d-none">
            </td>
            <td>{{ txn.date|date:"M d, Y" }}</td>
            <td>{{ txn.description }}</td>
            <td>{{ txn.get_transaction_type_display }}</td>
            <td>{{ txn.account_source }}</td>
            <td>{{ txn.account_destination }}</td>
             <td class="text-end">{{ txn.amount|floatformat:2|intcomma }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="6" class="text-center">No transactions yet.</td></tr>
        {% endfor %}
      </tbody>
      </table>
    </form>
  </div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  /* ---------- mga element refs ---------- */
  const actionSelect      = document.getElementById('action-select');
  const rows              = document.querySelectorAll('.clickable-row');
  const selectAllCheckbox = document.getElementById('select-all');
  const rowCheckboxes     = document.querySelectorAll('.row-checkbox');
  const checkboxColumns   = document.querySelectorAll('.select-checkbox');
  const applyButton       = document.getElementById('apply-button');
  
  /* ---------- flag para alam kung bulk mode ---------- */
  let bulkMode = false;

  /* ---------- dropdown change (= toggle bulk mode) ---------- */
  actionSelect.addEventListener('change', function () {
    bulkMode = this.value === 'delete_multiple';
    applyButton.disabled = !this.value;

    checkboxColumns.forEach(el => el.style.display = bulkMode ? 'table-cell' : 'none');
    selectAllCheckbox.classList.toggle('d-none', !bulkMode);

    if (!bulkMode) {
      selectAllCheckbox.checked = false;
      rowCheckboxes.forEach(cb => { cb.classList.add('d-none'); cb.checked = false; });
    } else {
      rowCheckboxes.forEach(cb => cb.classList.remove('d-none'));
    }

      });

       // initialize state on load
  actionSelect.dispatchEvent(new Event('change'));

  selectAllCheckbox.addEventListener('change', function () {
    const checked = this.checked;
    rowCheckboxes.forEach(cb => {
      if (!cb.classList.contains('d-none')) cb.checked = checked;
    });
  });

  rows.forEach(row => {
    row.addEventListener('click', function (e) {
  
      if (bulkMode || e.target.closest('input[type="checkbox"]')) return;

      const url = this.dataset.href;
      if (url) window.location = url;
    });
  });
});
</script>
{% endblock %}